var data = [
    {
      "_id": "56c8ec14061b2d440baf43df",
      "amount": 1,
      "description": "Payment to Pocket Change",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8ec76061b2d440baf43e0",
      "amount": 1,
      "description": "Payment to Pocket Change",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8edf0061b2d440baf43e4",
      "amount": 1,
      "description": "Payment to Pocket Change",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8ee0b061b2d440baf43e6",
      "amount": 1,
      "description": "Payment to Pocket Change",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8eea0061b2d440baf43e8",
      "amount": 1,
      "description": "Payment to Pocket Change for Spotify Premium",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f2ec061b2d440baf43ef",
      "amount": 1,
      "description": "Payment to Pocket Change for Spotify Premium",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f36c061b2d440baf43f0",
      "amount": 5,
      "description": "Hey",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c4d",
      "payer_id": "56c66be6a73e492741507c4c",
      "status": "executed",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f477061b2d440baf43f2",
      "amount": 1,
      "description": "Payment to Pocket Change for Spotify Premium",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b92",
      "payer_id": "56c66be6a73e492741507b93",
      "status": "cancelled",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f5b6061b2d440baf43f3",
      "amount": 50,
      "description": "string",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b35",
      "payer_id": "56c66be6a73e492741507b34",
      "status": "executed",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f5db061b2d440baf43f4",
      "amount": 50,
      "description": null,
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507b35",
      "payer_id": "56c66be6a73e492741507b34",
      "status": "executed",
      "type": "p2p"
    },
    {
      "_id": "56c8f613061b2d440baf43f5",
      "amount": 50,
      "description": "string",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c64",
      "payer_id": "56c66be6a73e492741507c61",
      "status": "executed",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f765061b2d440baf43f7",
      "amount": 100,
      "description": "string",
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c7f",
      "payer_id": "56c66be6a73e492741507c7e",
      "status": "executed",
      "transaction_date": "2016-02-20",
      "type": "p2p"
    },
    {
      "_id": "56c8f81b061b2d440baf43f8",
      "amount": 10,
      "description": null,
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c64",
      "payer_id": "56c66be6a73e492741507c61",
      "status": "executed",
      "type": "p2p"
    },
    {
      "_id": "56c8f889061b2d440baf43fa",
      "amount": 10,
      "description": null,
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c64",
      "payer_id": "56c66be6a73e492741507c61",
      "status": "executed",
      "type": "p2p"
    },
    {
      "_id": "56c8fc3b061b2d440baf43fe",
      "amount": 10,
      "description": null,
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c64",
      "payer_id": "56c66be6a73e492741507c61",
      "status": "executed",
      "type": "p2p"
    },
    {
      "_id": "56c8fc7f061b2d440baf43ff",
      "amount": 1,
      "description": null,
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c64",
      "payer_id": "56c66be6a73e492741507c61",
      "status": "executed",
      "type": "p2p"
    },
    {
      "_id": "56c8fccf061b2d440baf4401",
      "amount": 20,
      "description": null,
      "medium": "balance",
      "payee_id": "56c66be6a73e492741507c64",
      "payer_id": "56c66be6a73e492741507c61",
      "status": "executed",
      "type": "p2p"
    }
];

(function(window, document){
    var TRANSACTION_DURATION = 120; // in frames

    /*
     * Basic Transfer function that keeps track of Polyline
     * coordinates over TRANSACTION_DURATION number of frames.
     */
    var Transfer = function(start, end){
        this.start = start;
        this.current = start;
        this.end = end;
        this.frame = 0;

        this._xIncrement = (this.end.x - this.start.x) / TRANSACTION_DURATION;
        this._yIncrement = (this.end.y - this.start.y) / TRANSACTION_DURATION;
    };

    /*
     * Increment function that signals a frame advance.
     * Returns true if the Transaction is done being drawn.
     * Returns false otherwise.
     */
    Transfer.prototype.increment = function(){
        if(this.frame == 0){
            this.current = this.end;
            return true;
        }
        else{
            this.frame++;
            this.current.x += this._xIncrement;
            this.current.y += this._yIncrement;
            return false;
        }
    };

    var transfers = [];
    var locations = {};

    for(var x = 0; x < data.length; x++){
        // Only process executed requests.
        if(!data[x]['status'] === 'executed')
            continue;

        (function(data){
            // get_location is implemented synchrnously.
            if(!location.hasOwnProperty(data[payee_id])){
                get_location(data[payee_id], function(payee_loc){
                    locations[payee_id] = payee_loc;
                });
            }
            if(!location.hasOwnProperty(data[payer_id])){
                get_location(data[payer_id], function(payer_loc){
                    locations[payer_id] = payer_loc;
                });
            }

            transfers.push(new Transfer(locations[payer_id], locations[payee_id]));
        })(data[x]);
    }

    var ele = document.getElementById('map');
    var map = new googlemaps.Map(ele, {
        // zoom: 5,
        mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    function render(){
        if(!transfers.length)
            return;

        var transfer = transfers[0];
        var path = new google.maps.Polyline({
            path: transfer.current,
            // geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        path.setMap(map);

        if(transfer.increment())
            transfers.splice(0, 1);

        window.requestAnimationFrame(render);
    }

    window.requestAnimationFrame(render);
})(window, document);

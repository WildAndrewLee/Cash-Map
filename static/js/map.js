var data = [
  {
    "_id": "56ff682c480cf02f0f88a5af",
    "merchant_id": "56c66be6a73e492741507641",
    "medium": "balance",
    "purchase_date": "2016-04-02",
    "amount": 500,
    "status": "executed",
    "description": "Help",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507641"
  },
  {
    "_id": "56ff6898480cf02f0f88a5b0",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-02",
    "amount": 500,
    "status": "executed",
    "description": "Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff68b3480cf02f0f88a5b1",
    "merchant_id": "56c66be6a73e492741507634",
    "medium": "balance",
    "purchase_date": "2016-04-02",
    "amount": 100,
    "status": "executed",
    "description": "Fix",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507634"
  },
  {
    "_id": "56ff68c6480cf02f0f88a5b2",
    "merchant_id": "56c66be6a73e492741507635",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 100,
    "status": "executed",
    "description": "Birthday gift",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507635"
  },
  {
    "_id": "56ff6983480cf02f0f88a5b4",
    "merchant_id": "56c66be6a73e492741507640",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 10,
    "status": "executed",
    "description": "Clothes",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507640"
  },
  {
    "_id": "56ff69f4480cf02f0f88a5b5",
    "merchant_id": "56c66be6a73e492741507638",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 20,
    "status": "executed",
    "description": "Dinner",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507638"
  },
  {
    "_id": "56ff6a05480cf02f0f88a5b6",
    "merchant_id": "56c66be6a73e492741507636",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 10,
    "status": "executed",
    "description": "Donuts and Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507636"
  },
  {
    "_id": "56ff6a15480cf02f0f88a5b7",
    "merchant_id": "56c66be6a73e492741507629",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 20,
    "status": "executed",
    "description": "Game night",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507629"
  },
  {
    "_id": "56ff6a3c480cf02f0f88a5b8",
    "merchant_id": "56c66be6a73e492741507628",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 20,
    "status": "executed",
    "description": "Dinner",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507628"
  }/* ,
  {
    "_id": "56ff6a4a480cf02f0f88a5b9",
    "merchant_id": "56c66be6a73e492741507625",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 200,
    "status": "executed",
    "description": "Cable TV",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507625"
  },
  {
    "_id": "56ff6a58480cf02f0f88a5ba",
    "merchant_id": "56c66be6a73e492741507624",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 45,
    "status": "executed",
    "description": "Consulting",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507624"
  },
  {
    "_id": "56ff6a65480cf02f0f88a5bb",
    "merchant_id": "56c66be6a73e492741507633",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 45,
    "status": "executed",
    "description": "Energy help",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507633"
  },
  {
    "_id": "56ff6a76480cf02f0f88a5bc",
    "merchant_id": "56c66be6a73e49274150763b",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 15,
    "status": "executed",
    "description": "Night food",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763b"
  },
  {
    "_id": "56ff6a9a480cf02f0f88a5bd",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 5,
    "status": "executed",
    "description": "Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff6aa1480cf02f0f88a5be",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Coffee and donuts",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff6ab0480cf02f0f88a5bf",
    "merchant_id": "56c66be6a73e492741507636",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Snack",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507636"
  },
  {
    "_id": "56ff6abf480cf02f0f88a5c0",
    "merchant_id": "56c66be6a73e49274150763c",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Gift",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763c"
  },
  {
    "_id": "56ff6ad4480cf02f0f88a5c1",
    "merchant_id": "56c66be6a73e49274150762a",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Groceries",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762a"
  },
  {
    "_id": "56ff6aef480cf02f0f88a5c2",
    "merchant_id": "56c66be6a73e492741507626",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 8,
    "status": "executed",
    "description": "n/a",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507626"
  },
  {
    "_id": "56ff6b00480cf02f0f88a5c3",
    "merchant_id": "56c66be6a73e49274150762c",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 150,
    "status": "executed",
    "description": "NBA tickets",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762c"
  },
  {
    "_id": "56ff6b11480cf02f0f88a5c4",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 4,
    "status": "executed",
    "description": "Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff6b3f480cf02f0f88a5c5",
    "merchant_id": "56c66be6a73e49274150763a",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 4,
    "status": "executed",
    "description": "ATM Fee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763a"
  },
  {
    "_id": "56ff6b52480cf02f0f88a5c6",
    "merchant_id": "56c66be6a73e49274150763f",
    "medium": "balance",
    "purchase_date": "2016-04-07",
    "amount": 150,
    "status": "executed",
    "description": "Truck lease",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763f"
  },
  {
    "_id": "56ff6b5f480cf02f0f88a5c7",
    "merchant_id": "56c66be6a73e492741507640",
    "medium": "balance",
    "purchase_date": "2016-04-07",
    "amount": 30,
    "status": "executed",
    "description": "Clothes",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507640"
  },
  {
    "_id": "56ff6b74480cf02f0f88a5c8",
    "merchant_id": "56c66be6a73e492741507635",
    "medium": "balance",
    "purchase_date": "2016-04-07",
    "amount": 30,
    "status": "executed",
    "description": "Anniversary gift",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507635"
  },
  {
    "_id": "56ff6b85480cf02f0f88a5c9",
    "merchant_id": "56c66be6a73e492741507630",
    "medium": "balance",
    "purchase_date": "2016-04-08",
    "amount": 15,
    "status": "executed",
    "description": "n/a",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507630"
  },
  {
    "_id": "56ff6b90480cf02f0f88a5ca",
    "merchant_id": "56c66be6a73e492741507637",
    "medium": "balance",
    "purchase_date": "2016-04-08",
    "amount": 15,
    "status": "executed",
    "description": "n/a",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507637"
  } */
];

$(function(){
    var TRANSACTION_DURATION = 50; // in frames

    /*
     * Basic Transfer function that keeps track of Polyline
     * coordinates over TRANSACTION_DURATION number of frames.
     */
    var Transfer = function(start, end){
        this.start = start;
        this.current = {lat: start.lat, lng: start.lng};
        this.end = end;
        this.frame = 0;

        this._xIncrement = (this.end.lat - this.start.lat) / TRANSACTION_DURATION;
        this._yIncrement = (this.end.lng - this.start.lng) / TRANSACTION_DURATION;
    };

    /*
     * Increment function that signals a frame advance.
     * Returns true if the Transaction is done being drawn.
     * Returns false otherwise.
     */
    Transfer.prototype.increment = function(){
        if(this.frame === TRANSACTION_DURATION){
            this.current = this.end;
            return true;
        }
        else{
            this.frame++;
            this.current.lat += this._xIncrement;
            this.current.lng += this._yIncrement;
            return false;
        }
    };

    /*
     * Restructure all data so that purchases are grouped in subarrays
     * by date.
     */
    var structured_data = [];

    for(var x = 0; x < data.length; x++){
        var last_batch = structured_data[structured_data.length - 1];

        if(!last_batch || last_batch[0].purchase_date !== data[x].purchase_date){
            structured_data.push([data[x]]);
        }
        else{
            last_batch.push(data[x]);
        }
    }

    /*
     * Generate a human date string.
     */
    var format_date = function(date){
        var parts = date.split('-');
        var year = parts[0];
        var month = parts[1];
        var day = parts[2];

        var months = [
            'January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'Septemer',
            'October',
            'November',
            'December'
        ];

        return months[parseInt(month)] + ' ' + day + ', ' + year;
    };

    $('#dates').empty();

    var dates = [];

    for(var x = 0; x < structured_data.length; x++){
        var date = structured_data[x][0].purchase_date;
        var formatted_date = format_date(date);

        $('<aside>').attr('id', date)
            .addClass('purchase-date')
            .text(formatted_date)
            .appendTo('#dates');

        dates.push(date);
    }

    /*
     * Runtime variables.
     */
    var transfers = {};
    var locations = {};
    var rows = data.length;
    var payer = null;

    get_account('56ff6705480cf02f0f88a5ab').then(function(acc){
        return get_location(acc.customer_id);
    }).then(function(payer){
        var promise = $.Deferred();

        var load_single = function(data){
            // Only process executed requests.
            if(data.status !== 'executed')
                return;

            var promise = $.Deferred();

            var add_transfer = function(){
                if(!transfers.hasOwnProperty(data.purchase_date)){
                    transfers[data.purchase_date] = [
                        new Transfer(payer, locations[data.merchant_id])
                    ];
                }
                else{
                    transfers[data.purchase_date].push(new Transfer(payer, locations[data.merchant_id]));
                }
            };

            if(!locations.hasOwnProperty(data.merchant_id)){
                get_merchant(data.merchant_id).then(function(merchant){
                    locations[data.merchant_id] = merchant.geocode;
                    add_transfer();
                    promise.resolve();
                });
            }
            else{
                add_transfer();
            }

            return promise;
        };

        var all_done = [];
        var loader = null;

        var load_data = function(){
            if(data.length){
                all_done.push(load_single(data.shift()));
            }
            else{
                window.clearInterval(loader);
                $.when.apply(null, all_done).done(function(){
                    promise.resolve(payer);
                });
            }
        };

        loader = window.setInterval(load_data, 100);

        return promise;
    }).then(function(payer){
        console.log('done loading data');
        var ele = $('#map').get(0);

        var bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng(payer.lat, payer.lng));

        for(var x = 0; x < dates.length; x++){
            var for_date = transfers[dates[x]];

            for(var y = 0; y < for_date.length; y++){
                var lat = for_date[y].end.lat;
                var lng = for_date[y].end.lng;

                bounds.extend(new google.maps.LatLng(lat, lng));
            }
        }

        var map = new google.maps.Map(ele, {
            center: payer
        });

        map.fitBounds(bounds);

        function render(){
            if(!dates.length)
                return;

            var day = transfers[dates[0]];

            for(var x = 0; x < day.length; x++){
                var transfer = day[x];

                var path = new google.maps.Polyline({
                    path: [transfer.start, transfer.current],
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });

                path.setMap(map);

                $('.selected').removeClass('selected');
                $('#' + dates[0]).addClass('selected');

                if(transfer.increment())
                    dates.shift();
            }

            window.requestAnimationFrame(render);
        }

        var listener = map.addListener('tilesloaded', function(){
            setTimeout(function(){
                window.requestAnimationFrame(render);
            }, 500);

            listener.remove();
        });
    });
});

var data = [
  {
    "_id": "56ff682c480cf02f0f88a5af",
    "merchant_id": "56c66be6a73e492741507641",
    "medium": "balance",
    "purchase_date": "2016-04-02",
    "amount": 500,
    "status": "executed",
    "description": "Help",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507641"
  },
  {
    "_id": "56ff6898480cf02f0f88a5b0",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-02",
    "amount": 500,
    "status": "executed",
    "description": "Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff68b3480cf02f0f88a5b1",
    "merchant_id": "56c66be6a73e492741507634",
    "medium": "balance",
    "purchase_date": "2016-04-02",
    "amount": 100,
    "status": "executed",
    "description": "Fix",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507634"
  },
  {
    "_id": "56ff68c6480cf02f0f88a5b2",
    "merchant_id": "56c66be6a73e492741507635",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 100,
    "status": "executed",
    "description": "Birthday gift",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507635"
  },
  {
    "_id": "56ff6983480cf02f0f88a5b4",
    "merchant_id": "56c66be6a73e492741507640",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 10,
    "status": "executed",
    "description": "Clothes",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507640"
  },
  {
    "_id": "56ff69f4480cf02f0f88a5b5",
    "merchant_id": "56c66be6a73e492741507638",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 20,
    "status": "executed",
    "description": "Dinner",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507638"
  },
  {
    "_id": "56ff6a05480cf02f0f88a5b6",
    "merchant_id": "56c66be6a73e492741507636",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 10,
    "status": "executed",
    "description": "Donuts and Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507636"
  },
  {
    "_id": "56ff6a15480cf02f0f88a5b7",
    "merchant_id": "56c66be6a73e492741507629",
    "medium": "balance",
    "purchase_date": "2016-04-03",
    "amount": 20,
    "status": "executed",
    "description": "Game night",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507629"
  },
  {
    "_id": "56ff6a3c480cf02f0f88a5b8",
    "merchant_id": "56c66be6a73e492741507628",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 20,
    "status": "executed",
    "description": "Dinner",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507628"
  },
  {
    "_id": "56ff6a4a480cf02f0f88a5b9",
    "merchant_id": "56c66be6a73e492741507625",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 200,
    "status": "executed",
    "description": "Cable TV",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507625"
  },
  {
    "_id": "56ff6a58480cf02f0f88a5ba",
    "merchant_id": "56c66be6a73e492741507624",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 45,
    "status": "executed",
    "description": "Consulting",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507624"
  },
  {
    "_id": "56ff6a65480cf02f0f88a5bb",
    "merchant_id": "56c66be6a73e492741507633",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 45,
    "status": "executed",
    "description": "Energy help",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507633"
  },
  {
    "_id": "56ff6a76480cf02f0f88a5bc",
    "merchant_id": "56c66be6a73e49274150763b",
    "medium": "balance",
    "purchase_date": "2016-04-04",
    "amount": 15,
    "status": "executed",
    "description": "Night food",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763b"
  },
  {
    "_id": "56ff6a9a480cf02f0f88a5bd",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 5,
    "status": "executed",
    "description": "Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff6aa1480cf02f0f88a5be",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Coffee and donuts",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff6ab0480cf02f0f88a5bf",
    "merchant_id": "56c66be6a73e492741507636",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Snack",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507636"
  },
  {
    "_id": "56ff6abf480cf02f0f88a5c0",
    "merchant_id": "56c66be6a73e49274150763c",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Gift",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763c"
  },
  {
    "_id": "56ff6ad4480cf02f0f88a5c1",
    "merchant_id": "56c66be6a73e49274150762a",
    "medium": "balance",
    "purchase_date": "2016-04-05",
    "amount": 8,
    "status": "executed",
    "description": "Groceries",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762a"
  },
  {
    "_id": "56ff6aef480cf02f0f88a5c2",
    "merchant_id": "56c66be6a73e492741507626",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 8,
    "status": "executed",
    "description": "n/a",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507626"
  },
  {
    "_id": "56ff6b00480cf02f0f88a5c3",
    "merchant_id": "56c66be6a73e49274150762c",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 150,
    "status": "executed",
    "description": "NBA tickets",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762c"
  },
  {
    "_id": "56ff6b11480cf02f0f88a5c4",
    "merchant_id": "56c66be6a73e49274150762f",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 4,
    "status": "executed",
    "description": "Coffee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150762f"
  },
  {
    "_id": "56ff6b3f480cf02f0f88a5c5",
    "merchant_id": "56c66be6a73e49274150763a",
    "medium": "balance",
    "purchase_date": "2016-04-06",
    "amount": 4,
    "status": "executed",
    "description": "ATM Fee",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763a"
  },
  {
    "_id": "56ff6b52480cf02f0f88a5c6",
    "merchant_id": "56c66be6a73e49274150763f",
    "medium": "balance",
    "purchase_date": "2016-04-07",
    "amount": 150,
    "status": "executed",
    "description": "Truck lease",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e49274150763f"
  },
  {
    "_id": "56ff6b5f480cf02f0f88a5c7",
    "merchant_id": "56c66be6a73e492741507640",
    "medium": "balance",
    "purchase_date": "2016-04-07",
    "amount": 30,
    "status": "executed",
    "description": "Clothes",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507640"
  },
  {
    "_id": "56ff6b74480cf02f0f88a5c8",
    "merchant_id": "56c66be6a73e492741507635",
    "medium": "balance",
    "purchase_date": "2016-04-07",
    "amount": 30,
    "status": "executed",
    "description": "Anniversary gift",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507635"
  },
  {
    "_id": "56ff6b85480cf02f0f88a5c9",
    "merchant_id": "56c66be6a73e492741507630",
    "medium": "balance",
    "purchase_date": "2016-04-08",
    "amount": 15,
    "status": "executed",
    "description": "n/a",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507630"
  },
  {
    "_id": "56ff6b90480cf02f0f88a5ca",
    "merchant_id": "56c66be6a73e492741507637",
    "medium": "balance",
    "purchase_date": "2016-04-08",
    "amount": 15,
    "status": "executed",
    "description": "n/a",
    "type": "merchant",
    "payer_id": "56ff6705480cf02f0f88a5ab",
    "payee_id": "56c66be6a73e492741507637"
  }
];

$(function(){
    var TRANSACTION_DURATION = 10; // in frames

    /*
     * Basic Transfer function that keeps track of Polyline
     * coordinates over TRANSACTION_DURATION number of frames.
     */
    var Transfer = function(start, end){
        this.start = start;
        this.current = {lat: start.lat, lng: start.lng};
        this.end = end;
        this.frame = 0;

        this._xIncrement = (this.end.lat - this.start.lat) / TRANSACTION_DURATION;
        this._yIncrement = (this.end.lng - this.start.lng) / TRANSACTION_DURATION;
    };

    /*
     * Increment function that signals a frame advance.
     * Returns true if the Transaction is done being drawn.
     * Returns false otherwise.
     */
    Transfer.prototype.increment = function(){
        if(this.frame === TRANSACTION_DURATION){
            this.current = this.end;
            return true;
        }
        else{
            this.frame++;
            this.current.lat += this._xIncrement;
            this.current.lng += this._yIncrement;
            return false;
        }
    };

    /*
     * Restructure all data so that purchases are grouped in subarrays
     * by date.
     */
    var structured_data = [];

    for(var x = 0; x < data.length; x++){
        var last_batch = structured_data[structured_data.length - 1];

        if(!structured_data.length || last_batch[0].purchase_data != data[x].purchase_data){
            last_batch = [];
            structured_data.push(last_patch);
        }

        last_batch.push(data[x]);
    }

    /*
     * Generate a list of dates.
     */
    var dates = [];

    for(var x = 0; x < structured_data.length; x++){
        dates.push(structured_data[x][0].purchase_date;
    }

    /*
     * Runtime variables.
     */
    var transfers = [];
    var locations = {};
    var rows = data.length;
    var payer = null; 

    get_account('56ff6705480cf02f0f88a5ab').then(function(acc){
        return get_location(acc.customer_id);
    }).then(function(payer){
        var promise = $.Deferred();

        var load_single = function(data){
            // Only process executed requests.
            if(data.status !== 'executed')
                return;

            var add_transfer = function(){
                transfers.push(new Transfer(payer, locations[data.merchant_id]));
            };

            if(!locations.hasOwnProperty(data.merchant_id)){
                get_merchant(data.merchant_id).then(function(merchant){
                    locations[data.merchant_id] = merchant.geocode;
                    add_transfer();
                });
            }
            else{
                add_transfer();
            }
        }

        var load_data = function(){
            if(data.length){
                load_single(data.shift());
                setTimeout(load_data, 100);
            }
            else{
                promise.resolve();
            }
        };

        load_data();

        return promise;
    }); 

    get_payer_loc(load_data);

    var wait = function(cb){
        if(transfers.length !== rows)
            setTimeout(function(){
                wait(cb);
            }, 100);
        else{
            cb();
        }
    };

    var run = function(){
        var ele = document.getElementById('map');
        var map = new google.maps.Map(ele, {
            zoom: 15,
            center: {lat: 39.9050, lng: -75.1652},
        });

        function render(){
            if(!transfers.length)
                return;

            var transfer = transfers[0];
            var path = new google.maps.Polyline({
                path: [transfer.start, transfer.current],
                // geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            path.setMap(map);

            if(transfer.increment())
                transfers.shift();

            window.requestAnimationFrame(render);
        }

        map.addListener('tilesloaded', function(){
            window.requestAnimationFrame(render);
            map.removeListener('tilesloaded');
        });
    };

    wait(run);
});
